# 🔐 ユーザーモデルの状態管理について：2 つのフラグの役割

ユーザー認証モデルにおいて、`is_active` および `status_code` は、それぞれ異なる目的と責任レベルを持つアカウントの状態を示します。

厳格モデルを採用することで、`is_active` フラグに**メール認証状態**の責任も統合します。

## 1. 各フラグの詳細な役割

| **フラグ/コード** | **責任のレイヤー**                | **目的**                                                                                                   | **取りうる値/例**                                   |
| :---------------- | :-------------------------------- | :--------------------------------------------------------------------------------------------------------- | :-------------------------------------------------- |
| **`is_active`**   | **システム制御** (認証層)         | **ログイン可否**を判定する最も基本的なフラグ。メール認証の成否もこのフラグに統合されます。                 | `True` (ログイン可) / `False` (ログイン不可)        |
| **`status_code`** | **論理的ライフサイクル** (業務層) | アカウントの**永続的な業務上の状態**を示すコード。利用規約違反や退会などの論理的な運用のために使われます。 | `ACTIVE` (10), `FROZEN` (40), `WITHDRAWN` (99) など |

---

## 2. 状態遷移と連携のパターン

これら 2 つの要素は、アカウントのライフサイクルを通じて連携し、以下のような重要な状態を表現します。

| **シナリオ**               | **is_active** | **status_code** | **意味**                                                                     |
| :------------------------- | :------------ | :-------------- | :--------------------------------------------------------------------------- |
| **新規登録直後**           | `False`       | `ACTIVE`        | メール認証が未完了のためログイン不可。                                       |
| **アクティベーション完了** | `True`        | `ACTIVE`        | 通常の利用可能状態。メール所有権も確認済み。                                 |
| **メールアドレス変更中**   | `False`       | `ACTIVE`        | **厳格モデル適用:** 変更申請により一時的にログイン不可の状態。認証完了待ち。 |
| **管理者が停止**           | `False`       | `ACTIVE`        | 管理者の操作により一時的にログイン不可の状態。                               |
| **アカウント凍結**         | `False`       | `FROZEN`        | 業務上の理由により永久にログインがブロックされた状態。                       |

### 連携のポイント

1.  **アクティベーション時**:

    - **`is_active`** は `False` から `True` へ遷移（**ログイン許可**）。

2.  **メールアドレス変更時**:

    - **`is_active`** を `True` から `False` へ強制的に遷移させ、変更完了まで全セッションを遮断します。

3.  **ログイン判定時**:
    - **`is_active` が `True`** であることが大前提となります。`status_code` がロック状態の場合は、その後のロジックでログインをブロックします。

---

## 3. メールアドレス変更時の挙動：厳格モデルの採用

本システムでは、セキュリティを重視し、**「厳格」モデル**を採用します。

1.  メールアドレス変更申請と同時に、**`is_active` を `False` に更新**し、ユーザーを強制的にログアウトさせ、**サービス利用を不可**にします。
2.  新しいメールアドレスの有効化リンクをクリックし、認証が完了した時点で、**`is_active` が `True`** に戻り、ログイン制限が解除されます。
