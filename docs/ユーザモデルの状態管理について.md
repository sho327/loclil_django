# 🔐 ユーザーモデルの状態管理について：3 つのフラグの役割

ユーザー認証モデルにおいて、`is_active`、および `status_code` は、それぞれ異なる目的と責任レベルを持つアカウントの状態を示します。

これらを区別して使用することで、柔軟かつ厳密なセキュリティおよびビジネス制御が可能になります。

## 1. 各フラグの詳細な役割

| **フラグ/コード** | **責任のレイヤー**                | **目的**                                                                                                   | **取りうる値/例**                                   |
| :---------------- | :-------------------------------- | :--------------------------------------------------------------------------------------------------------- | :-------------------------------------------------- |
| **`is_active`**   | **システム制御** (認証層)         | **ログイン可否**を判定する最も基本的なフラグ。Django の認証バックエンドが直接参照します。                  | `True` (ログイン可) / `False` (ログイン不可)        |
| **`status_code`** | **論理的ライフサイクル** (業務層) | アカウントの**永続的な業務上の状態**を示すコード。利用規約違反や退会などの論理的な運用のために使われます。 | `ACTIVE` (10), `FROZEN` (40), `WITHDRAWN` (99) など |

### 補足：`status_code` の利用例

`status_code` は、`is_active` が `True` の状態にあるユーザーに対しても、ビジネス上の制限をかけるために使用されます。

- **一時ロック (`TEMPORARY_LOCKED`)**: ログイン試行失敗回数超過など、システムが自動的に一時的な制限をかける場合。

- **永続凍結 (`FROZEN`)**: 管理者が利用規約違反によりアカウントを停止した場合。

- **退会済み (`WITHDRAWN`)**: ユーザー自身が退会手続きを完了した場合。

---

## 2. 状態遷移と連携のパターン

これら 3 つの要素は、アカウントのライフサイクルを通じて連携し、以下のような重要な状態を表現します。

| **シナリオ**               | **is_active** | **is_email_verified** | **status_code** | **意味**                                                                         |
| :------------------------- | :------------ | :-------------------- | :-------------- | :------------------------------------------------------------------------------- |
| **新規登録直後**           | `False`       | `False`               | `ACTIVE`        | データベースに作成されたが、メール認証が未完了のためログイン不可。               |
| **アクティベーション完了** | `True`        | `True`                | `ACTIVE`        | 通常の利用可能状態。メール所有権も確認済み。                                     |
| **メールアドレス変更中**   | `True`        | `False`               | `ACTIVE`        | ログインは可能だが、機密操作（パスワード変更など）はブロックされる可能性がある。 |
| **管理者が停止**           | `False`       | `True`                | `ACTIVE`        | メール認証はされているが、管理者の操作により一時的にログイン不可の状態。         |
| **アカウント凍結**         | `False`       | `True`                | `FROZEN`        | メール認証はされているが、業務上の理由により永久にログインがブロックされた状態。 |

### 連携のポイント

1. **アクティベーション時**:

   - **`is_active`** は `False` から `True` へ遷移（**ログイン許可**）。

2. **ログイン判定時**:

   - 最も厳しいチェックは、通常 **`is_active` が `True`** であることです。

   - ただし、`status_code` が `TEMPORARY_LOCKED` や `FROZEN` の場合は、`is_active` が `True` であってもログインをブロックするロジックを実装する必要があります。

---

## 3. メールアドレス変更時の挙動：厳格モデル vs ソフトコミット

登録済みのメールアドレスを変更する際（`is_email_verified` が一時的に `False` になる期間）、セキュリティと利便性のバランスに応じて 2 つのアプローチがあります。

### A. 厳格モデル (Strict Model)

Twitter (X) や金融機関など、匿名性が高い、または極めて高いセキュリティが求められるサービスで採用されます。

- **挙動**: 変更申請と同時に**全セッションを強制ログアウト**（`is_active` を一時的に無効化に近い扱いにする）、または機能を大幅に制限します。
- **メリット**: 不正アクセス時のリスクを最小限に抑えられる。
- **デメリット**: ユーザーの作業が強制的に中断され、認証完了までサービスが利用できない。

### B. ソフトコミット (Soft Commit)

Asana, Trello などの B2B/SaaS ツールや、一般的な Web サービスで採用されます。

- **挙動**: **ログインセッションを維持**したまま、新しいメールアドレスの認証を待ちます。ただし、前述の「機密操作」のみをブロックします。
- **メリット**: ユーザーの業務や作業を中断させず、利便性を維持できる。
- **デメリット**: 厳格モデルに比べると、不正アクセス検知後の対応猶予が短い（ただし、元のメールアドレスへ通知することでカバーする）。

### 📌 本システムの方針：厳格モデルの採用

本システムでは、Twitter に合わせて匿名ユーザ向け として**匿名性/セキュリティ**を重視し、**「厳格」**モデルを採用します。

1.  メールアドレス変更申請中は、ユーザーは**ログインしたままサービスを利用不可**です。
2.  新しいメールアドレスのリンクをクリックし、認証が完了した時点で、制限が解除されます。
